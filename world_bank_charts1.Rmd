---
title: "Public Health Data - World Bank"
output:
  html_document: default
  html_notebook: default
---



```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggthemes)
library(ggrepel)
library(scales)
library(ellipse)
```


# Get data
```{r}
df.per.capita<- read.csv('data/API_SH.XPD.PCAP_DS2_en_csv_v2.csv',skip = 4,stringsAsFactors = FALSE)
#df.per.capita<- read.csv('data/API_SH.XPD.PUBL_DS2_en_csv_v2.csv',skip = 4,stringsAsFactors = FALSE)

missing.years<- c(1960:1994,2015:2016)
missing.years.columns<- paste0("X",missing.years)
valid.years<- c(1995:2014)
valid.years.columns<- paste0("X",valid.years)
df.per.capita<-df.per.capita %>% select(-one_of(missing.years.columns))

## drop the countries with missing data
df.per.capita<-df.per.capita %>% filter(!is.na(X1995))
df.per.capita <-df.per.capita %>% filter(grepl("Low income|Lower middle income|Upper middle income|High income",Country.Name))
str(df.per.capita)
df.per.capita <- df.per.capita %>% select(one_of(c("Country.Name",valid.years.columns))) 

```
## Add quartile groups
```{r}
# df.per.capita <- df.per.capita %>%    mutate(quartile = ntile(X2014, 4)) %>% arrange((quartile))
# 
# groupy <-df.per.capita %>% group_by(quartile) %>% summarise_at(valid.years.columns,funs(mean))
```
## Tranpose
```{r}
gato<-df.per.capita %>% gather(year,expenditure,-Country.Name)
gato <- gato %>% mutate(year=as.numeric(gsub('X','',year)))
gato$Country.Name <- as.factor(gato$Country.Name)
gato$Country.Name <- factor(gato$Country.Name,  levels=rev(c("Low income","Lower middle income","Low & middle income","Middle income", "Upper middle income","High income")))


```

```{r}
colors.vector<- rev(c("#fa9fb5","#f768a1","#c51b8a","#7a0177"))

title<- c("Gesundheitsausgaben pro Kopf in US $","$US")
#title<- c("Öffentliche Gesundheitsausgaben als Anteil der Gesamtgesundheitsausgaben","%")



ggplot(data=gato ,aes(x=year,y=log(expenditure),colour=(Country.Name)))+theme_minimal()+ geom_line(size=1)+labs(colour="")+ theme(axis.title = element_text(), axis.title.x=element_blank(), axis.text.x = element_text(angle = 90, hjust = 1),legend.text=element_text(size=10),plot.caption=element_text(size=8))+ ggtitle(title[1])+ylab(title[2]) + scale_colour_manual(values = colors.vector, labels = (c("Länder mit hohem Einkommen","Länder mit gehobenem mittleren Einkommen","Länder mit niedrigem mittleren Einkommen","Länder mit niedrigem Einkommen")))+  guides(fill = guide_legend(nrow = 2,ncol = 2, title.hjust = 0.4))+  guides(col = guide_legend(nrow = 2))+  theme(legend.position="bottom")


```

```{r}
df2<-read.csv('data/dataset2.csv',stringsAsFactors = FALSE)
df2<- df2 %>% mutate(Ausgaben.von.Pflichtkrankenversicherungen = ifelse(is.na(Ausgaben.von.Pflichtkrankenversicherungen),0,Ausgaben.von.Pflichtkrankenversicherungen))

df2<- df2 %>% mutate(Steuerfinanzierte.Gesundheitsausgaben = ifelse(is.na(Steuerfinanzierte.Gesundheitsausgaben),0,Steuerfinanzierte.Gesundheitsausgaben))


CODE_TO_EXCLUDE_FROM_ELLIPSE = c('MEX','US','GRE')
df2<-df2 %>% mutate(group=ifelse(Steuerfinanzierte.Gesundheitsausgaben<35,"Sozialversicherungssysteme","Steuerfinanzierte Systeme"))
df2<-df2 %>% mutate(group=ifelse(CODE %in% CODE_TO_EXCLUDE_FROM_ELLIPSE,"-",group))
df2$group<-as.factor(df2$group)

ggplot(df2,aes(x=Steuerfinanzierte.Gesundheitsausgaben,y=Ausgaben.von.Pflichtkrankenversicherungen))+  geom_text(check_overlap = TRUE,size=4,color="#7a0177",aes(label = CODE, colour = factor(group)), size = 4) +labs(x='Steuerfinanzierte Gesundheitsausgaben (%)',y='Ausgaben von Pflichtkrankenversicherungen (%)')

```

```{r}

# create ellipsis :
df_ell<-data.frame()
for(g in levels(df2$group)){
  if (g!='-'){
    df_ell <- rbind(df_ell, cbind(as.data.frame(with(df2[df2$group==g,], ellipse(cor(Steuerfinanzierte.Gesundheitsausgaben, Ausgaben.von.Pflichtkrankenversicherungen), 
                                         scale=c(sd(Steuerfinanzierte.Gesundheitsausgaben),sd(Ausgaben.von.Pflichtkrankenversicherungen)), 
                                         centre=c(mean(Steuerfinanzierte.Gesundheitsausgaben),mean(Ausgaben.von.Pflichtkrankenversicherungen))))),group=g))
    
  }



}

```

```{r}
p <- ggplot(df2,aes(x=Steuerfinanzierte.Gesundheitsausgaben,y=Ausgaben.von.Pflichtkrankenversicherungen))+  geom_text(check_overlap = TRUE,aes(label = CODE, colour = factor(group)),fontface = "bold", size = 3,show.legend = TRUE,font=TRUE) +labs(x='Steuerfinanzierte Gesundheitsausgaben (%)',y='Ausgaben von Pflichtkrankenversicherungen (%)')+theme(legend.title=element_blank())+labs(text = "")+scale_colour_brewer(palette = "Set2")#+geom_label(aes(fill = factor(group),label = CODE),size=2, colour = "white", fontface = "bold")
#p<-p+geom_path(data=df_ell, aes(x=x, y=y,colour=group), size=0.5, linetype=1)
p

```


```

