---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(eurostat)
library(dplyr)
library(lubridate)
library(stringr)
library(tidyr)
library(ggplot2)
library(plotly)
library(ggrepel)



library(broom)


```

## filter on specific EU Countries
```{r}
data("eu_countries")

countries <- read.csv('countries_list.csv',header = F)
colnames(countries)<- c('name')
countries.with.code <- merge(countries,eu_countries,by='name')

norway <- data.frame('Norway','NO','')
names(norway)<- names(countries.with.code)
turkey <- data.frame('Turkey','TR','')
names(turkey)<- names(countries.with.code)
countries.with.code<-rbind(countries.with.code,norway,turkey)
codes.countries <- c(countries.with.code$code,'TR','NO')
```

## load data
```{r}

data <-get_eurostat('hlth_rs_prsrg',  stringsAsFactors = FALSE)
data <- data %>% filter(isco08 %in%        c('OC222_322','OC221')) %>% filter( nchar(geo) == 2) %>% filter(unit=='P_HTHAB')

data <-data %>% filter(grepl(paste(codes.countries, collapse="|"), geo))
data$country.code <- str_sub(data$geo,1,2)

data <- data %>% filter(year(time)>2004)
nuts2.names <-label_eurostat(data %>% select(geo,unit))
colnames(nuts2.names) <- c('geo.name','unit.name')
data <- cbind(data,nuts2.names)

data <- merge(data,countries.with.code,by.x='country.code',by.y='code')
data$year <- lubridate::year(data$time)
data <- data %>% arrange(year)

```

## CAGR
```{r}

groupy <- data %>% group_by(geo,isco08)%>% mutate(last.doctors.density=last(values))
df.cagr <- groupy  %>%
  group_by(geo, isco08) %>%
  dplyr::summarise(growth.percent = (last(values)-first(values))/first(values)*100,
   cagr = ((last(values) / first(values)) ^ (1 / (max(year) - min(year))) - 1) *
  100)

df.cagr <-merge(df.cagr,distinct(data[c('geo','name')]),by='geo',all.x=FALSE)

last.doctors.density <- data %>% filter(isco08=='OC221') %>% select(geo,year,isco08,values) %>% group_by(geo,isco08) %>% summarise(last.doct.density=last(values)) %>% select(-isco08)

df.cagr <- merge(df.cagr,last.doctors.density,by='geo',all.x=T)

```


## model

```{r}

df.cagr.spreado<- df.cagr %>% select(-growth.percent) %>% spread(isco08,cagr)

plot_ly(df.cagr.spreado ,x=~OC221,y=~OC222_322,color=~name,type = 'scatter',text = ~ paste(name, geo))
    
```
#Linear Regression
```{r}
df.model.rsquared <-df.cagr.spreado %>% drop_na()  %>% 
  group_by(name) %>% 
  do(glance(lm(OC221~OC222_322, data = .))) 

df.model.coef <-df.cagr.spreado %>% drop_na()  %>% 
  group_by(name) %>% 
  do(tidy(lm(OC221~OC222_322, data = .)))  %>% slice(2)
```

# nurses density vs doctos density



```{r}
data.density <- data %>% spread(isco08,values) %>% drop_na() %>% arrange(year)



data.density<- data.density# %>% filter(country.code=='FR')#  & geo=='CZ01')

data.density$legend.name <- str_replace(data.density$geo.name,"\\(NUTS 2013","")
data.density$legend.name <- str_replace(data.density$legend.name,"\\)","")


data.density <- data.density %>% group_by(geo) %>% mutate(text.plot = paste0(legend.name,' (',first(year),'-',last(year),')'))



 

```

```{r}


plot.density.scatter.timeline <- function(code.country) {
  data <- data.density# %>% filter(country.code==code.country)
  
  data.range.start <- data %>%
    group_by(geo) %>%
    arrange(year) %>%
    filter(row_number() == 1)
  
  data.range.stop <- data %>%
    group_by(geo) %>%
    arrange(year) %>%
    filter(row_number() == n())
  
  data.range.stop.second <- data.range.stop
  
  over.countries <- as.factor(c('IT','ES','BG','CZ','SK','HU','HR'))
  
  data.range.stop <-
    data.range.stop %>% mutate(text.plot = ifelse(country.code %in% over.countries, country.code, text.plot))
  
  data.range.stop.second <- data.range.stop.second %>% filter(country.code %in% over.countries)
  
  data.range.stop.second$index <- as.numeric(row.names(data.range.stop.second))
  print(data.range.stop.second)
  data.range.stop.second$index <- 1700-50*data.range.stop.second$index
  
  data.range.stop.second <-
    data.range.stop.second %>% mutate(OC221 = ifelse(country.code %in% over.countries, 550, OC221)) %>% mutate(OC222_322 =                                                                                        ifelse(country.code %in%over.countries, index, OC222_322))
  
  print(data.range.stop.second)
  
  
  
  p <- ggplot(data, aes(OC221, OC222_322, group = legend.name))
  p <- p +
    geom_point(data = data.range.start,
               color = 'black',
               size = 1) +
    
    geom_point(
      data = data.range.stop,
      color = 'black',
      size = 2,
      shape = 21
    ) +
    geom_point(
      data = data.range.start,
      color = 'black',
      size = 1,
      shape = 1
    ) +
    theme_bw() +    ylab("Nurses & Midwives per 100.000") +
    xlab("Doctors  per 100.000") +  labs(color = paste(sprintf('\u2022'), 'from ', sprintf('\u25e6'), 'to')) +
    
    geom_path(aes(color = text.plot)) + #theme(legend.position = "bottom") +
    
    
    # add only for countries level, not for NUTS2
    geom_text(
      data = data.range.stop,
      aes(label = text.plot, colour = factor(geo.name)),
      hjust = 1,
      nudge_x = 0,
      vjust = -1,
      nudge_y = 0,
      size = 2,
      check_overlap = TRUE
    ) +
    geom_text(
      data = data.range.stop.second,
      aes(label = text.plot, colour = factor(geo.name)),
      hjust = 0,
      nudge_x = 0,
      vjust = 0,
      nudge_y = 0,
      size = 2,
      check_overlap = FALSE
    ) +
    #theme(legend.text = element_text(size = 4))
    theme(legend.position = "none")# + coord_flip()
  #coord_equal() +xlim(c(0,1600)) + ylim(c(0,1600))+
  
  ggsave(paste0(code.country, '.png'), p)
  return(p)
}
plot.density.scatter.timeline('all_UE')
```


```{r}
plot.density.scatter.timeline.nuts2 <- function(code.country) {
  data <- data.density %>% filter(country.code==code.country)
  
  data.range.start <- data %>%
    group_by(geo) %>%
    arrange(year) %>%
    filter(row_number() == 1)
  
  data.range.stop <- data %>%
    group_by(geo) %>%
    arrange(year) %>%
    filter(row_number() == n())
  
  
  p <- ggplot(data, aes(OC221, OC222_322, group = legend.name))
  p <- p +
    geom_point(data = data.range.start,
               color = 'black',
               size = 1) +
    
    geom_point(
      data = data.range.stop,
      color = 'black',
      size = 2,
      shape = 21
    ) +
    geom_point(
      data = data.range.start,
      color = 'black',
      size = 1,
      shape = 1
    ) +
    theme_bw() +    ylab("Nurses & Midwives per 100.000") +
    xlab("Doctors  per 100.000") +  labs(color = paste(sprintf('\u2022'), 'from ', sprintf('\u25e6'), 'to')) +
    
    geom_path(aes(color = text.plot)) +#theme(legend.position = "bottom") +
    
  

    theme(legend.text = element_text(size = 4))
   
    
  ggsave(paste0(code.country, '.png'), p)
  return(p)
}

```

```{r}

for(country in codes.countries){
  plot.density.scatter.timeline.nuts2(country)
}
```

